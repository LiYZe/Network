# UDP协议



由"标头"和"数据"两部分组成。

"标头"主要定义了发出端口和接收端口，8个字节，总长度不超过65,535字节。

"数据"部分就是具体的内容。

优点：简单，容易实现

缺点：可靠性较差

## UDP的校验和

UDP对首部和数据部分都进行校验，而IP首部的校验和仅对IP的首部进行校验

UDP的校验和是可选的，而TCP的是必选的。

## 不可靠协议

UDP是不可靠的协议，没有超时和重传功能，当UDP数据封装到IP数据报传输时，如果丢失，会发送一个ICMP差错报文给源主机。如果有错误也会丢掉。

## 路径MTU发现

利用路径MTU发现机制，应用程序可以充分利用更大的MTU来发送报文。

# TCP协议

提供了一种可靠的、面向连接的数据传输服务

优点：确保不会遗失

内嵌在IP数据包的"数据"部分。

TCP数据包没有长度限制

![image](https://user-images.githubusercontent.com/37955886/119924616-84e4de00-bfa6-11eb-9f51-1ac0fe818f1d.png)

## TCP连接的建立

![image](https://user-images.githubusercontent.com/37955886/119925379-ebb6c700-bfa7-11eb-9374-92e26ca0f9f2.png)

## TCP关闭

![image](https://user-images.githubusercontent.com/37955886/119925463-17d24800-bfa8-11eb-973d-9c650c4bc91a.png)

## 拥塞控制机制

防止过多的数据注入到网络中，从而使网络中的路由器或链路不致过载。

：慢开始、拥塞避免、快重传、快恢复四种算法。

### 慢开始

从小到大逐渐增大发送窗口。

刚开始发送报文段时，先把拥塞窗口设置为一个最大报文段MSS的数值，而在每收到对上一轮报文段的确认后，把拥塞窗口的数值加倍。

### 拥塞避免

当拥塞窗口的值小于慢开始门限时，使用慢开始算法，一旦拥塞窗口的值大于慢开始门限的值，就改用拥塞避免算法。

让拥塞窗口缓慢地增大，收到每一轮的确认后，将拥塞窗口的值加1，而不是加倍。

### 快重传

首先要求接收方每收到一个失序的报文段后就立即发出重复确认,如果发送方连续收到三个重复确认，就应该立即重传对方未收到的报文段

## 定时器

### 重传定时器

计算TCP报文段的超时重传时间的。

如果在定时器时间到后还没收到对该报文段的确认，就重传该报文段，并将重传定时器复位，重新计算；如果在规定时间内收到了对该报文段的确认，则撤销该报文段的重传定时器。

### 坚持定时器 

只要TCP连接的一方收到对方的零窗口通知，就启动坚持定时器。若坚持定时器设置的时间到期，就发送一个零窗口控测报文段。

三种情况：

1、对方在收到探测报文段后，如果窗口值仍为零，则收到报文段的一方将坚持定时器的值加倍并重启。坚持计数器最大只能增加到约60秒，在此之后，每次收到零窗口通知，坚持计数器的值就定位60秒。

2、对方在收到探测报文段后，如果窗口不为零，那么解决死锁。

3、该探测报文发出后，同时启动重传定时器，如果重传定时器的时间到期，还没有收到接收到发来的响应，则超时重传探测报文。

### 保活定时器

为了应对两个TCP连接间出现长时间的没有数据传输的情况。

服务器每收到一次客户端的数据，就重新设置保活定时器，通常为2小时，如果2小时没有收到客户端的数据，服务端就发送一个探测报文，以后每隔75秒发送一次，如果连续发送10次探测报文段后仍没有收到客户端的响应，服务器就认为客户端出现了故障，就可以终止这个连接。

### 2MSL定时器 

主要是为了确保发送的最后一个ACK报文段能够到达对方，并防止之前与本连接有关的由于延迟等原因而导致已失效的报文被误判为有效。

## 交互数据流

每按下一个键，要回显一些字符。

为了提高这类数据的发送效率和降低网络负担，TCP采用了两种策略：捎带ACK和Nagle算法。

###  捎带ACK

当接收端接收到TCP报文段后，并不立即发送ACK报文，而是等上一段时间，如果这段时间里该主机有数据要发送到远程主机，就将该数据捎带上ACK一起发送过去

### Nagle算法

应用程序把要发送的数据逐个字节地存到TCP的发送缓存，把前面的一部分数据先发送出去，并把后面到达的字节继续缓存起来，当收到前面字节的确认后，再把发送缓冲中的所有数据组装成一个报文段发送出去，同时继续对随后到来的数据进行缓存。只有收到前一个报文段的确认后才能继续发送下一个报文段。

## 成块数据流

总是希望每次发送尽可能多的数据到主机。TCP使用滑动窗口协议。

### 滑动窗口

允许发送方在停止发送前和等待确认前可以连续发送多个分组，因此可以加速数据的传输。  

以字节为单位的，

发送方和接收方在TCP三次握手的前两次握手时协商好了发送窗口和接受窗口的大小，发送方根据接受方发送来的确认连接报文中标明的窗口的大小，来确定收到确认前的最大发送数据量，如果为0则停止发送数据，直到不为0。

发送方不必发送一个全窗口大小的数据，一次发送一部分即可。

窗口的大小可以减小，但是窗口的右边沿却不能向左移动。

接收方在发送一个ACK前不必等待窗口被填满。

窗口的大小是相对于确认序号的，收到确认后的窗口的左边沿从确认序号开始。


